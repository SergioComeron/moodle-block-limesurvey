/**
 * JavaScript for loading LimeSurvey surveys.
 *
 * @module     block_limesurvey/surveys
 * @copyright  2024, Sergio
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str"],(function(e,o,s,r){var t=function(e){if(!e||"null"===e||null===e)return"";try{var o=new Date(e);if(isNaN(o.getTime()))return"";return o.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){return""}},n=function(e){if(!e||"null"===e||null===e)return 999;try{var o=new Date(e),s=new Date,r=new Date(o.getFullYear(),o.getMonth(),o.getDate())-new Date(s.getFullYear(),s.getMonth(),s.getDate()),t=Math.round(r/864e5);return 0===t&&o<s?-1:t}catch(e){return 999}};return{init:function(){console.log("ğŸ¯ LimeSurvey block: Initializing..."),window.sessionStorage.getItem("limesurvey_survey_clicked")&&(console.log("ğŸ”„ User returned from survey, clearing cache..."),window.sessionStorage.removeItem("limesurvey_survey_clicked"),this.clearCache()),this.loadSurveys()},clearCache:function(){o.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done((function(e){console.log("âœ… Cache cleared:",e)})).fail((function(e){console.error("âŒ Error clearing cache:",e)}))},loadSurveys:function(){console.log("ğŸ“ Getting content div...");var i=e("#limesurvey-content");console.log("Content div found:",i.length>0);console.log("ğŸ“ Loading language strings..."),r.get_strings([{key:"nosurveys",component:"block_limesurvey"},{key:"activesurveys",component:"block_limesurvey"},{key:"viewresponses",component:"block_limesurvey"},{key:"hideresponses",component:"block_limesurvey"},{key:"responses",component:"block_limesurvey"},{key:"error_loading",component:"block_limesurvey"},{key:"surveyprogress",component:"block_limesurvey"},{key:"allcompleted",component:"block_limesurvey"},{key:"expiresin",component:"block_limesurvey"},{key:"expiresday",component:"block_limesurvey"},{key:"expirestoday",component:"block_limesurvey"},{key:"expired",component:"block_limesurvey"}]).then((function(r){console.log("âœ… Language strings loaded:",r);var a={nosurveys:r[0],activesurveys:r[1],viewresponses:r[2],hideresponses:r[3],responses:r[4],error_loading:r[5],surveyprogress:r[6],allcompleted:r[7],expiresin:r[8],expiresday:r[9],expirestoday:r[10],expired:r[11]};!function(e,r,i){console.log("ğŸš€ LimeSurvey block: Loading surveys..."),o.call([{methodname:"block_limesurvey_get_surveys",args:{}}])[0].done((function(o){if(console.log("âœ… LimeSurvey API response received:",o),o.success)if(0!==o.surveys.length){var s=o.surveys.length,a=0,l=0;o.surveys.forEach((function(e){e.completed?a++:l++}));var d=Math.round(a/s*100);o.surveys.sort((function(e,o){return e.completed&&!o.completed?1:!e.completed&&o.completed?-1:e.completed||o.completed?0:n(e.expires)-n(o.expires)})),console.group("ğŸ“Š LimeSurvey - Survey Responses"),console.log("Total surveys:",s),console.log("Completed:",a),console.log("Pending:",l),console.log("Completion:",d+"%");var p="";l>0?(p+='<div style="margin-bottom: 16px;">',p+='<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">',p+='<span style="font-size: 0.85em; color: #666; font-weight: 500;">',p+=i.surveyprogress.replace("{$a->completed}",a).replace("{$a->total}",s),p+="</span>",p+='<span style="font-size: 0.85em; color: #1565c0; font-weight: 600;">'+d+"%</span>",p+="</div>",p+='<div style="background: #e0e0e0; height: 4px; border-radius: 2px; overflow: hidden;">',p+='<div style="background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%); height: 100%; width: '+d+'%; transition: width 0.5s ease;"></div>',p+="</div>",p+="</div>"):(p+='<div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; border-left: 3px solid #4caf50; text-align: center; font-weight: 600; color: #2e7d32; font-size: 0.9em;">',p+="ğŸ‰ "+i.allcompleted+"</div>"),p+='<div style="display: flex; flex-direction: column; gap: 10px;">',o.surveys.forEach((function(e,o){if(!e.completed&&(a=n(e.expires))<0)console.log("â­ï¸ Skipping expired survey:",e.title);else{var s=e.attributes.length>0?e.attributes.join(", "):"",r="survey-"+o;if(e.completed)p+='<div style="padding: 12px 16px; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">',p+='<div style="display: flex; align-items: center; justify-content: space-between;">',p+='<div style="flex: 1;">',p+='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 4px;"><span style="margin-right: 8px;">âœ“</span>'+e.title+"</div>",s&&(p+='<div style="font-size: 0.85em; color: #558b2f;">'+s+"</div>"),(e.startdate||e.expires)&&(p+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(p+='<span style="color: #558b2f;"><strong>Start:</strong> '+t(e.startdate)+"</span>"),e.expires&&(p+='<span style="color: #d84315;"><strong>Expires:</strong> '+t(e.expires)+"</span>"),p+="</div>"),p+="</div>",p+='<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Completed</span>',p+="</div>",Object.keys(e.responses).length>0&&(p+='<button class="btn btn-sm view-responses" data-survey-id="'+r+'" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid #4caf50; color: #4caf50; border-radius: 4px; font-size: 0.85em; cursor: pointer; transition: all 0.2s;">ğŸ“Š '+i.viewresponses+"</button>",p+='<div id="'+r+'-responses" class="survey-responses" style="display: none; margin-top: 8px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #c8e6c9;"></div>'),p+="</div>";else{var a,l=function(e,o){return e<0?'<span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 8px rgba(211,47,47,0.5); white-space: nowrap;">'+o.expired+"</span>":0===e?'<span class="expires-today-badge" style="background: #ff5722; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 12px rgba(255,87,34,0.8); white-space: nowrap;">'+o.expirestoday+"</span>":1===e?'<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 6px rgba(255,152,0,0.4); white-space: nowrap;">'+o.expiresday+"</span>":e<=7?'<span style="background: #ffa726; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; white-space: nowrap;">'+o.expiresin.replace("{$a}",e)+"</span>":""}(a=n(e.expires),i),d="linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)",c="#2196f3";a<0?(d="linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)",c="#d32f2f"):a<=1?(d="linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)",c="#ff5722"):a<=7&&(d="linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)",c="#ff9800"),p+='<a href="'+e.url+'" target="_blank" class="limesurvey-link" style="text-decoration: none;">',p+='<div style="padding: 12px 16px; border-radius: 8px; background: '+d+"; border-left: 4px solid "+c+"; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;\" onmouseover=\"this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';\" onmouseout=\"this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)';\">",p+='<div style="display: flex; align-items: center; justify-content: space-between;">',p+='<div style="flex: 1;">',p+='<div style="font-weight: 600; color: #1565c0; margin-bottom: 4px;"><span style="margin-right: 8px;">â†’</span>'+e.title+l+"</div>",s&&(p+='<div style="font-size: 0.85em; color: #1976d2;">'+s+"</div>"),(e.startdate||e.expires)&&(p+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(p+='<span style="color: #1565c0;"><strong>Start:</strong> '+t(e.startdate)+"</span>"),e.expires&&(p+='<span style="color: #d84315;"><strong>Expires:</strong> '+t(e.expires)+"</span>"),p+="</div>"),p+="</div>",p+='<span style="background: #2196f3; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Pending</span>',p+="</div>",p+="</div>",p+="</a>"}console.group(o+1+". "+e.title),console.log("Status:",e.completed?"âœ… Completed":"â¬œï¸ Pending"),console.log("URL:",e.url),e.attributes.length>0&&console.log("Attributes:",e.attributes),console.group("ğŸ” API Response Details"),console.log("Raw API Response:",e.raw_api_response),console.log("Decoded Data:",e.decoded_data),console.groupEnd(),e.completed&&(e.responseid&&console.log("Response ID:",e.responseid),Object.keys(e.responses).length>0?console.log("Responses:",e.responses):console.log("No response data available")),console.groupEnd()}})),console.groupEnd(),p+="</div>",r.html(p);var c=e(".expires-today-badge");c.length>0&&setInterval((function(){c.fadeOut(600).fadeIn(600)}),1200),e(".limesurvey-link").on("click",(function(){window.sessionStorage.setItem("limesurvey_survey_clicked","true"),console.log("ğŸ“ Survey link clicked, will clear cache on return")})),e(".view-responses").on("click",(function(s){s.preventDefault();var r=e(this).data("survey-id"),t=e("#"+r+"-responses"),n=o.surveys[parseInt(r.split("-")[1])],a=e(this);if(t.is(":visible"))t.slideUp(),a.html("ğŸ“Š "+i.viewresponses);else{var l='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;">'+i.responses+":</div>";for(var d in l+='<div style="display: grid; gap: 8px;">',n.responses)n.responses.hasOwnProperty(d)&&(l+='<div style="padding: 8px; background: #f1f8e9; border-radius: 4px; border-left: 3px solid #4caf50;">',l+='<div style="font-size: 0.8em; color: #558b2f; margin-bottom: 2px;">'+d+"</div>",l+='<div style="color: #2e7d32; font-weight: 500;">'+n.responses[d]+"</div>",l+="</div>");l+="</div>",t.html(l),t.slideDown(),a.html("ğŸ“Š "+i.hideresponses)}}))}else r.html("<p>"+i.nosurveys+"</p>");else r.html('<div class="alert alert-warning">'+o.message+"</div>")})).fail((function(e){r.html('<div class="alert alert-danger">'+i.error_loading+"</div>"),s.exception(e),console.error("âŒ Error loading LimeSurvey data:",e)}))}(e,i,a)})).catch((function(e){console.error("âŒ Error loading strings:",e),i.html('<div class="alert alert-danger">Error loading language strings</div>')}))}}}));