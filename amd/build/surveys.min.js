define(["jquery","core/ajax","core/notification","core/str"],function(t,d,o,e){function g(e){if(!e||"null"===e||null===e)return"";try{var o=new Date(e);if(isNaN(o.getTime()))return"";return o.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){return""}}function f(e){if(!e||"null"===e||null===e)return 999;try{var o=new Date(e),t=new Date,s=new Date(o.getFullYear(),o.getMonth(),o.getDate())-new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=Math.round(s/864e5);return 0===r&&o<t?-1:r}catch(e){return 999}}function s(l,a,c){console.log("ğŸš€ LimeSurvey block: Loading surveys..."),d.call([{methodname:"block_limesurvey_get_surveys",args:{}}])[0].done(function(n){var e,o,t,s,r,p,i;console.log("âœ… LimeSurvey API response received:",n),n.success?0!==n.surveys.length?(e=n.surveys.length,s=t=o=0,n.surveys.forEach(function(e){e.completed?o++:t++,s+=e.completion_percentage||0}),r=0<e?Math.round(s/e):0,n.surveys.sort(function(e,o){return e.completed&&!o.completed?1:!e.completed&&o.completed?-1:e.completed||o.completed?0:f(e.expires)-f(o.expires)}),console.group("ğŸ“Š LimeSurvey - Survey Responses"),console.log("Total surveys:",e),console.log("Completed:",o),console.log("Pending:",t),console.log("Completion:",r+"%"),p="",p=0<t?(p=(p+='<div style="margin-bottom: 16px;"><div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 6px;">')+'<span style="font-size: 0.85em; color: #1565c0; font-weight: 600;">'+r+"%</span></div>")+'<div style="background: #e0e0e0; height: 4px; border-radius: 2px; overflow: hidden;"><div style="background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%); height: 100%; width: '+r+'%; transition: width 0.5s ease;"></div></div></div>':(p+='<div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; border-left: 3px solid #4caf50; text-align: center; font-weight: 600; color: #2e7d32; font-size: 0.9em;">')+"ğŸ‰ "+c.allcompleted+"</div>",p+='<div style="display: flex; flex-direction: column; gap: 10px;">',n.surveys.forEach(function(e,o){if(!e.completed&&(t=f(e.expires))<0)return void console.log("â­ï¸ Skipping expired survey:",e.title);var t,s,r,n,i,l,a=0<e.attributes.length?e.attributes.join(", "):"",d="survey-"+o;e.completed?(p=(p+='<div style="padding: 12px 16px; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><div style="display: flex; align-items: center; justify-content: space-between;"><div style="flex: 1;">')+'<div style="font-weight: 600; color: #2e7d32; margin-bottom: 4px;"><span style="margin-right: 8px;">âœ“</span>'+e.title+"</div>",a&&(p+='<div style="font-size: 0.85em; color: #558b2f;">'+a+"</div>"),(e.startdate||e.expires)&&(p+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(p+='<span style="color: #558b2f;"><strong>Start:</strong> '+g(e.startdate)+"</span>"),e.expires&&(p+='<span style="color: #d84315;"><strong>Expires:</strong> '+g(e.expires)+"</span>"),p+="</div>"),p+='</div><span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Completed</span></div>',0<Object.keys(e.responses).length&&(p=p+('<button class="btn btn-sm view-responses" data-survey-id="'+d+'" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid #4caf50; color: #4caf50; border-radius: 4px; font-size: 0.85em; cursor: pointer; transition: all 0.2s;">ğŸ“Š '+c.viewresponses)+'</button><div id="'+d+'-responses" class="survey-responses" style="display: none; margin-top: 8px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #c8e6c9;"></div>'),p+="</div>"):(t=f(e.expires),d=c,d=(l=t)<0?'<span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 8px rgba(211,47,47,0.5); white-space: nowrap;">'+d.expired+"</span>":0===l?'<span class="expires-today-badge" style="background: #ff5722; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 12px rgba(255,87,34,0.8); white-space: nowrap;">'+d.expirestoday+"</span>":1===l?'<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 6px rgba(255,152,0,0.4); white-space: nowrap;">'+d.expiresday+"</span>":l<=7?'<span style="background: #ffa726; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; white-space: nowrap;">'+d.expiresin.replace("{$a}",l)+"</span>":"",l="linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)",n="#2196f3",s="#1976d2",r=i="#1565c0",100===e.completion_percentage?(l="linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)",n="#4caf50",i="#2e7d32",r=s="#558b2f"):t<0?(l="linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)",n="#d32f2f"):t<=1?(l="linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)",n="#ff5722"):t<=7&&(l="linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)",n="#ff9800"),p=(p=p+('<a href="'+e.url)+'" target="_blank" class="limesurvey-link" style="text-decoration: none;"><div style="padding: 12px 16px; border-radius: 8px; background: '+l+"; border-left: 4px solid "+n+'; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;" onmouseover="this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.15)\'; this.style.transform=\'translateY(-2px)\';" onmouseout="this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.1)\'; this.style.transform=\'translateY(0)\';"><div style="display: flex; align-items: center; justify-content: space-between;"><div style="flex: 1;">')+'<div style="font-weight: 600; color: '+i+'; margin-bottom: 4px;"><span style="margin-right: 8px;">â†’</span>'+e.title+d+"</div>",a&&(p+='<div style="font-size: 0.85em; color: '+s+';">'+a+"</div>"),(e.startdate||e.expires)&&(p+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(p+='<span style="color: '+r+';"><strong>Start:</strong> '+g(e.startdate)+"</span>"),e.expires&&(p+='<span style="color: #d84315;"><strong>Expires:</strong> '+g(e.expires)+"</span>"),p+="</div>"),p+="</div>",l=e.completion_percentage||0,n=2*Math.PI*18,p=(p=(p+='<div style="position: relative; width: 48px; height: 48px;"><svg width="48" height="48" style="transform: rotate(-90deg);">')+'<circle cx="24" cy="24" r="18" fill="none" stroke="#e0e0e0" stroke-width="4"></circle><circle cx="24" cy="24" r="18" fill="none" stroke="'+(i=l<30?"#f44336":l<70?"#ff9800":"#4caf50")+'" stroke-width="4" stroke-dasharray="'+n+'" stroke-dashoffset="'+(n-l/100*n)+'" stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;"></circle>')+'</svg><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 700; color: '+i+';">'+l+"%</div></div></div></div></a>"),console.group(o+1+". "+e.title),console.log("Status:",e.completed?"âœ… Completed":"â¬œï¸ Pending"),console.log("URL:",e.url),0<e.attributes.length&&console.log("Attributes:",e.attributes),console.group("ğŸ” API Response Details"),console.log("Raw API Response:",e.raw_api_response),console.log("Decoded Data:",e.decoded_data),console.groupEnd(),e.completed&&(e.responseid&&console.log("Response ID:",e.responseid),0<Object.keys(e.responses).length?console.log("Responses:",e.responses):console.log("No response data available")),console.groupEnd()}),console.groupEnd(),p+="</div>",a.html(p),0<(i=l(".expires-today-badge")).length&&setInterval(function(){i.fadeOut(600).fadeIn(600)},1200),l(".view-responses").on("click",function(e){e.preventDefault();var e=l(this).data("survey-id"),o=l("#"+e+"-responses"),t=n.surveys[parseInt(e.split("-")[1])],e=l(this);if(o.is(":visible"))o.slideUp(),e.html("ğŸ“Š "+c.viewresponses);else{var s,r='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;">'+c.responses+":</div>";for(s in r+='<div style="display: grid; gap: 8px;">',t.responses)t.responses.hasOwnProperty(s)&&(r=(r=r+'<div style="padding: 8px; background: #f1f8e9; border-radius: 4px; border-left: 3px solid #4caf50;"><div style="font-size: 0.8em; color: #558b2f; margin-bottom: 2px;">'+s+"</div>")+'<div style="color: #2e7d32; font-weight: 500;">'+t.responses[s]+"</div></div>");o.html(r+="</div>"),o.slideDown(),e.html("ğŸ“Š "+c.hideresponses)}}),l(".limesurvey-link").on("click",function(){console.log("ğŸ—‘ï¸ User clicked on survey, clearing cache..."),d.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done(function(e){console.log("âœ… Cache cleared:",e)}).fail(function(e){console.error("âŒ Error clearing cache:",e)})})):a.html("<p>"+c.nosurveys+"</p>"):a.html('<div class="alert alert-warning">'+n.message+"</div>")}).fail(function(e){a.html('<div class="alert alert-danger">'+c.error_loading+"</div>"),o.exception(e),console.error("âŒ Error loading LimeSurvey data:",e)})}return{init:function(){console.log("ğŸ¯ LimeSurvey block: Initializing..."),this.loadSurveys()},clearCache:function(){d.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done(function(e){console.log("âœ… Cache cleared:",e)}).fail(function(e){console.error("âŒ Error clearing cache:",e)})},loadSurveys:function(){console.log("ğŸ“ Getting content div...");var o=t("#limesurvey-content");console.log("Content div found:",0<o.length);console.log("ğŸ“ Loading language strings..."),e.get_strings([{key:"nosurveys",component:"block_limesurvey"},{key:"activesurveys",component:"block_limesurvey"},{key:"viewresponses",component:"block_limesurvey"},{key:"hideresponses",component:"block_limesurvey"},{key:"responses",component:"block_limesurvey"},{key:"error_loading",component:"block_limesurvey"},{key:"surveyprogress",component:"block_limesurvey"},{key:"allcompleted",component:"block_limesurvey"},{key:"expiresin",component:"block_limesurvey"},{key:"expiresday",component:"block_limesurvey"},{key:"expirestoday",component:"block_limesurvey"},{key:"expired",component:"block_limesurvey"}]).then(function(e){console.log("âœ… Language strings loaded:",e);e={nosurveys:e[0],activesurveys:e[1],viewresponses:e[2],hideresponses:e[3],responses:e[4],error_loading:e[5],surveyprogress:e[6],allcompleted:e[7],expiresin:e[8],expiresday:e[9],expirestoday:e[10],expired:e[11]};s(t,o,e)}).catch(function(e){console.error("âŒ Error loading strings:",e),o.html('<div class="alert alert-danger">Error loading language strings</div>')})}}});
//# sourceMappingURL=surveys.min.js.map