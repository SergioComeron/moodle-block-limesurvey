/**
 * JavaScript for loading LimeSurvey surveys.
 *
 * @module     block_limesurvey/surveys
 * @copyright  2024, Sergio
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str"],(function(e,o,t,r){var s=function(e){if(!e||"null"===e||null===e)return"";try{var o=new Date(e);if(isNaN(o.getTime()))return"";return o.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){return""}},n=function(e){if(!e||"null"===e||null===e)return 999;try{var o=new Date(e),t=new Date,r=new Date(o.getFullYear(),o.getMonth(),o.getDate())-new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=Math.round(r/864e5);return 0===s&&o<t?-1:s}catch(e){return 999}};return{init:function(){console.log("üéØ LimeSurvey block: Initializing..."),this.loadSurveys()},clearCache:function(){o.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done((function(e){console.log("‚úÖ Cache cleared:",e)})).fail((function(e){console.error("‚ùå Error clearing cache:",e)}))},loadSurveys:function(){console.log("üìù Getting content div...");var i=e("#limesurvey-content");console.log("Content div found:",i.length>0);console.log("üìù Loading language strings..."),r.get_strings([{key:"nosurveys",component:"block_limesurvey"},{key:"activesurveys",component:"block_limesurvey"},{key:"viewresponses",component:"block_limesurvey"},{key:"hideresponses",component:"block_limesurvey"},{key:"responses",component:"block_limesurvey"},{key:"error_loading",component:"block_limesurvey"},{key:"surveyprogress",component:"block_limesurvey"},{key:"allcompleted",component:"block_limesurvey"},{key:"expiresin",component:"block_limesurvey"},{key:"expiresday",component:"block_limesurvey"},{key:"expirestoday",component:"block_limesurvey"},{key:"expired",component:"block_limesurvey"},{key:"startdate",component:"block_limesurvey"},{key:"expiresdate",component:"block_limesurvey"},{key:"surveylist",component:"block_limesurvey"},{key:"completedsurvey_aria",component:"block_limesurvey"},{key:"pendingsurvey_aria",component:"block_limesurvey"},{key:"progress_aria",component:"block_limesurvey"},{key:"completedstatus",component:"block_limesurvey"},{key:"pendingstatus",component:"block_limesurvey"}]).then((function(r){console.log("‚úÖ Language strings loaded:",r);var a={nosurveys:r[0],activesurveys:r[1],viewresponses:r[2],hideresponses:r[3],responses:r[4],error_loading:r[5],surveyprogress:r[6],allcompleted:r[7],expiresin:r[8],expiresday:r[9],expirestoday:r[10],expired:r[11],startdate:r[12],expiresdate:r[13],surveylist:r[14],completedsurvey_aria:r[15],pendingsurvey_aria:r[16],progress_aria:r[17],completedstatus:r[18],pendingstatus:r[19]};!function(e,r,i){console.log("üöÄ LimeSurvey block: Loading surveys..."),o.call([{methodname:"block_limesurvey_get_surveys",args:{}}])[0].done((function(t){if(console.log("‚úÖ LimeSurvey API response received:",t),t.success)if(0!==t.surveys.length){var a=t.surveys.length,l=0,d=0;t.surveys.forEach((function(e){e.completed?l++:d++}));var p=a>0?Math.round(l/a*100):0;t.surveys.sort((function(e,o){return e.completed&&!o.completed?1:!e.completed&&o.completed?-1:e.completed||o.completed?0:n(e.expires)-n(o.expires)})),console.group("üìä LimeSurvey - Survey Responses"),console.log("Total surveys:",a),console.log("Completed:",l),console.log("Pending:",d),console.log("Completion:",p+"%");var c="";d>0&&(c+='<div style="margin-bottom: 16px;">',c+='<div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 6px;">',c+='<span style="font-size: 0.85em; color: #1565c0; font-weight: 600;">'+p+"%</span>",c+="</div>",c+='<div style="background: #e0e0e0; height: 4px; border-radius: 2px; overflow: hidden;">',c+='<div style="background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%); height: 100%; width: '+p+'%; transition: width 0.5s ease;"></div>',c+="</div>",c+="</div>"),c+='<ul role="list" aria-label="'+i.surveylist+'" id="survey-list" style="display: flex; flex-direction: column; gap: 10px; list-style: none; padding: 0; margin: 0;">',t.surveys.forEach((function(e,o){if(!e.completed&&(a=n(e.expires))<0)console.log("‚è≠Ô∏è Skipping expired survey:",e.title);else{var t=e.attributes.length>0?e.attributes.join(", "):"";if(e.completed){var r=i.completedsurvey_aria.replace("{$a}",e.title);c+='<li role="listitem" style="list-style: none; padding: 0; margin: 0;">',c+='<a href="'+e.url+'" target="_blank" rel="noopener noreferrer" class="limesurvey-link" aria-label="'+r+'" style="text-decoration: none; display: block;">',c+="<div style=\"padding: 12px 16px; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;\" onmouseover=\"this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';\" onmouseout=\"this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)';\">",c+='<div style="display: flex; align-items: center; justify-content: space-between;">',c+='<div style="flex: 1;">',c+='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 4px;"><span aria-hidden="true" style="margin-right: 8px;">‚úì</span>'+e.title+"</div>",t&&(c+='<div style="font-size: 0.85em; color: #558b2f;">'+t+"</div>"),(e.startdate||e.expires)&&(c+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(c+='<span style="color: #558b2f;"><strong>'+i.startdate+":</strong> "+s(e.startdate)+"</span>"),e.expires&&(c+='<span style="color: #d84315;"><strong>'+i.expiresdate+":</strong> "+s(e.expires)+"</span>"),c+="</div>"),c+="</div>",c+='<span aria-label="'+i.completedstatus+'" style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">'+i.completedstatus+"</span>",c+="</div>",c+="</div>",c+="</a>",c+="</li>"}else{var a,l=function(e,o){return e<0?'<span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 8px rgba(211,47,47,0.5); white-space: nowrap;">'+o.expired+"</span>":0===e?'<span class="expires-today-badge" style="background: #ff5722; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 12px rgba(255,87,34,0.8); white-space: nowrap;">'+o.expirestoday+"</span>":1===e?'<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 6px rgba(255,152,0,0.4); white-space: nowrap;">'+o.expiresday+"</span>":e<=7?'<span style="background: #ffa726; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; white-space: nowrap;">'+o.expiresin.replace("{$a}",e)+"</span>":""}(a=n(e.expires),i),d="linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)",p="#2196f3",g="#1565c0",u="#1976d2",y="#1565c0";100===e.completion_percentage?(d="linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)",p="#4caf50",g="#2e7d32",u="#558b2f",y="#558b2f"):a<0?(d="linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)",p="#d32f2f"):a<=1?(d="linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)",p="#ff5722"):a<=7&&(d="linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)",p="#ff9800");var f=i.pendingsurvey_aria.replace("{$a}",e.title);c+='<li role="listitem" style="list-style: none; padding: 0; margin: 0;">',c+='<a href="'+e.url+'" target="_blank" rel="noopener noreferrer" class="limesurvey-link" aria-label="'+f+'" style="text-decoration: none; display: block;">',c+='<div style="padding: 12px 16px; border-radius: 8px; background: '+d+"; border-left: 4px solid "+p+"; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;\" onmouseover=\"this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';\" onmouseout=\"this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)';\">",c+='<div style="display: flex; align-items: center; justify-content: space-between;">',c+='<div style="flex: 1;">',c+='<div style="font-weight: 600; color: '+g+'; margin-bottom: 4px;"><span aria-hidden="true" style="margin-right: 8px;">‚Üí</span>'+e.title+l+"</div>",t&&(c+='<div style="font-size: 0.85em; color: '+u+';">'+t+"</div>"),(e.startdate||e.expires)&&(c+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(c+='<span style="color: '+y+';"><strong>'+i.startdate+":</strong> "+s(e.startdate)+"</span>"),e.expires&&(c+='<span style="color: #d84315;"><strong>'+i.expiresdate+":</strong> "+s(e.expires)+"</span>"),c+="</div>"),c+="</div>";var v=e.completion_percentage||0,m=2*Math.PI*18,x=m-v/100*m,h=v<30?"#f44336":v<70?"#ff9800":"#4caf50",b=i.progress_aria.replace("{$a}",v);c+='<div style="position: relative; width: 48px; height: 48px;">',c+='<svg width="48" height="48" role="img" aria-label="'+b+'" style="transform: rotate(-90deg);">',c+='<circle cx="24" cy="24" r="18" fill="none" stroke="#e0e0e0" stroke-width="4"></circle>',c+='<circle cx="24" cy="24" r="18" fill="none" stroke="'+h+'" stroke-width="4" stroke-dasharray="'+m+'" stroke-dashoffset="'+x+'" stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;"></circle>',c+="</svg>",c+='<div aria-hidden="true" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 700; color: '+h+';">'+v+"%</div>",c+="</div>",c+="</div>",c+="</div>",c+="</a>",c+="</li>"}console.group(o+1+". "+e.title),console.log("Status:",e.completed?"‚úÖ Completed":"‚¨úÔ∏è Pending"),console.log("URL:",e.url),e.attributes.length>0&&console.log("Attributes:",e.attributes),console.group("üîç API Response Details"),console.log("Raw API Response:",e.raw_api_response),console.log("Decoded Data:",e.decoded_data),console.groupEnd(),e.completed&&(e.responseid&&console.log("Response ID:",e.responseid),Object.keys(e.responses).length>0?console.log("Responses:",e.responses):console.log("No response data available")),console.groupEnd()}})),console.groupEnd(),c+="</ul>",r.html(c);var g=e(".expires-today-badge");g.length>0&&setInterval((function(){g.fadeOut(600).fadeIn(600)}),1200),e(".view-responses").on("click",(function(o){o.preventDefault();var r=e(this).data("survey-id"),s=e("#"+r+"-responses"),n=t.surveys[parseInt(r.split("-")[1])],a=e(this);if(s.is(":visible"))s.slideUp(),a.html("üìä "+i.viewresponses);else{var l='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;">'+i.responses+":</div>";for(var d in l+='<div style="display: grid; gap: 8px;">',n.responses)n.responses.hasOwnProperty(d)&&(l+='<div style="padding: 8px; background: #f1f8e9; border-radius: 4px; border-left: 3px solid #4caf50;">',l+='<div style="font-size: 0.8em; color: #558b2f; margin-bottom: 2px;">'+d+"</div>",l+='<div style="color: #2e7d32; font-weight: 500;">'+n.responses[d]+"</div>",l+="</div>");l+="</div>",s.html(l),s.slideDown(),a.html("üìä "+i.hideresponses)}})),e(".limesurvey-link").on("click",(function(){console.log("üóëÔ∏è User clicked on survey, clearing cache..."),o.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done((function(e){console.log("‚úÖ Cache cleared:",e)})).fail((function(e){console.error("‚ùå Error clearing cache:",e)}))}))}else r.html("<p>"+i.nosurveys+"</p>");else r.html('<div class="alert alert-warning">'+t.message+"</div>")})).fail((function(e){r.html('<div class="alert alert-danger">'+i.error_loading+"</div>"),t.exception(e),console.error("‚ùå Error loading LimeSurvey data:",e)}))}(e,i,a)})).catch((function(e){console.error("‚ùå Error loading strings:",e),i.html('<div class="alert alert-danger">Error loading language strings</div>')}))}}}));