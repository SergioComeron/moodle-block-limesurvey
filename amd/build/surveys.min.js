/**
 * JavaScript for loading LimeSurvey surveys.
 *
 * @module     block_limesurvey/surveys
 * @copyright  2024, Sergio
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str"],(function(e,o,r,t){var s=function(e){if(!e||"null"===e||null===e)return"";try{var o=new Date(e);if(isNaN(o.getTime()))return"";return o.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){return""}},n=function(e){if(!e||"null"===e||null===e)return 999;try{var o=new Date(e),r=new Date,t=new Date(o.getFullYear(),o.getMonth(),o.getDate())-new Date(r.getFullYear(),r.getMonth(),r.getDate()),s=Math.round(t/864e5);return 0===s&&o<r?-1:s}catch(e){return 999}};return{init:function(){console.log("ğŸ¯ LimeSurvey block: Initializing..."),this.loadSurveys()},clearCache:function(){o.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done((function(e){console.log("âœ… Cache cleared:",e)})).fail((function(e){console.error("âŒ Error clearing cache:",e)}))},loadSurveys:function(){console.log("ğŸ“ Getting content div...");var i=e("#limesurvey-content");console.log("Content div found:",i.length>0);console.log("ğŸ“ Loading language strings..."),t.get_strings([{key:"nosurveys",component:"block_limesurvey"},{key:"activesurveys",component:"block_limesurvey"},{key:"viewresponses",component:"block_limesurvey"},{key:"hideresponses",component:"block_limesurvey"},{key:"responses",component:"block_limesurvey"},{key:"error_loading",component:"block_limesurvey"},{key:"surveyprogress",component:"block_limesurvey"},{key:"allcompleted",component:"block_limesurvey"},{key:"expiresin",component:"block_limesurvey"},{key:"expiresday",component:"block_limesurvey"},{key:"expirestoday",component:"block_limesurvey"},{key:"expired",component:"block_limesurvey"},{key:"startdate",component:"block_limesurvey"},{key:"expiresdate",component:"block_limesurvey"},{key:"surveylist",component:"block_limesurvey"},{key:"completedsurvey_aria",component:"block_limesurvey"},{key:"pendingsurvey_aria",component:"block_limesurvey"},{key:"progress_aria",component:"block_limesurvey"},{key:"completedstatus",component:"block_limesurvey"},{key:"pendingstatus",component:"block_limesurvey"}]).then((function(t){console.log("âœ… Language strings loaded:",t);var a={nosurveys:t[0],activesurveys:t[1],viewresponses:t[2],hideresponses:t[3],responses:t[4],error_loading:t[5],surveyprogress:t[6],allcompleted:t[7],expiresin:t[8],expiresday:t[9],expirestoday:t[10],expired:t[11],startdate:t[12],expiresdate:t[13],surveylist:t[14],completedsurvey_aria:t[15],pendingsurvey_aria:t[16],progress_aria:t[17],completedstatus:t[18],pendingstatus:t[19]};!function(e,t,i){console.log("ğŸš€ LimeSurvey block: Loading surveys..."),o.call([{methodname:"block_limesurvey_get_surveys",args:{}}])[0].done((function(r){if(console.log("âœ… LimeSurvey API response received:",r),r.success)if(0!==r.surveys.length){var a=r.surveys.length,l=0,d=0,p=0;r.surveys.forEach((function(e){e.completed?l++:d++,p+=e.completion_percentage||0}));var c=a>0?Math.round(p/a):0;r.surveys.sort((function(e,o){return e.completed&&!o.completed?1:!e.completed&&o.completed?-1:e.completed||o.completed?0:n(e.expires)-n(o.expires)})),console.group("ğŸ“Š LimeSurvey - Survey Responses"),console.log("Total surveys:",a),console.log("Completed:",l),console.log("Pending:",d),console.log("Completion:",c+"%");var g="";d>0?(g+='<div style="margin-bottom: 16px;">',g+='<div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 6px;">',g+='<span style="font-size: 0.85em; color: #1565c0; font-weight: 600;">'+c+"%</span>",g+="</div>",g+='<div style="background: #e0e0e0; height: 4px; border-radius: 2px; overflow: hidden;">',g+='<div style="background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%); height: 100%; width: '+c+'%; transition: width 0.5s ease;"></div>',g+="</div>",g+="</div>"):(g+='<div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; border-left: 3px solid #4caf50; text-align: center; font-weight: 600; color: #2e7d32; font-size: 0.9em;">',g+="ğŸ‰ "+i.allcompleted+"</div>"),g+='<ul role="list" aria-label="'+i.surveylist+'" style="display: flex; flex-direction: column; gap: 10px; list-style: none; padding: 0; margin: 0;">',r.surveys.forEach((function(e,o){if(!e.completed&&(l=n(e.expires))<0)console.log("â­ï¸ Skipping expired survey:",e.title);else{var r=e.attributes.length>0?e.attributes.join(", "):"",t="survey-"+o;if(e.completed){var a=i.completedsurvey_aria.replace("{$a}",e.title);g+='<li role="listitem" aria-label="'+a+'" style="padding: 12px 16px; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">',g+='<div style="display: flex; align-items: center; justify-content: space-between;">',g+='<div style="flex: 1;">',g+='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 4px;"><span aria-hidden="true" style="margin-right: 8px;">âœ“</span>'+e.title+"</div>",r&&(g+='<div style="font-size: 0.85em; color: #558b2f;">'+r+"</div>"),(e.startdate||e.expires)&&(g+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(g+='<span style="color: #558b2f;"><strong>'+i.startdate+":</strong> "+s(e.startdate)+"</span>"),e.expires&&(g+='<span style="color: #d84315;"><strong>'+i.expiresdate+":</strong> "+s(e.expires)+"</span>"),g+="</div>"),g+="</div>",g+='<span aria-label="'+i.completedstatus+'" style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">'+i.completedstatus+"</span>",g+="</div>",Object.keys(e.responses).length>0&&(g+='<button class="btn btn-sm view-responses" data-survey-id="'+t+'" aria-label="'+i.viewresponses+" "+e.title+'" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid #4caf50; color: #4caf50; border-radius: 4px; font-size: 0.85em; cursor: pointer; transition: all 0.2s;"><span aria-hidden="true">ğŸ“Š </span>'+i.viewresponses+"</button>",g+='<div id="'+t+'-responses" class="survey-responses" style="display: none; margin-top: 8px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #c8e6c9;" role="region" aria-label="'+i.responses+" "+e.title+'"></div>'),g+="</li>"}else{var l,d=function(e,o){return e<0?'<span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 8px rgba(211,47,47,0.5); white-space: nowrap;">'+o.expired+"</span>":0===e?'<span class="expires-today-badge" style="background: #ff5722; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 12px rgba(255,87,34,0.8); white-space: nowrap;">'+o.expirestoday+"</span>":1===e?'<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 6px rgba(255,152,0,0.4); white-space: nowrap;">'+o.expiresday+"</span>":e<=7?'<span style="background: #ffa726; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; white-space: nowrap;">'+o.expiresin.replace("{$a}",e)+"</span>":""}(l=n(e.expires),i),p="linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)",c="#2196f3",u="#1565c0",y="#1976d2",f="#1565c0";100===e.completion_percentage?(p="linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)",c="#4caf50",u="#2e7d32",y="#558b2f",f="#558b2f"):l<0?(p="linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)",c="#d32f2f"):l<=1?(p="linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)",c="#ff5722"):l<=7&&(p="linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)",c="#ff9800");var v=i.pendingsurvey_aria.replace("{$a}",e.title);g+='<li role="listitem" style="list-style: none; padding: 0; margin: 0;">',g+='<a href="'+e.url+'" target="_blank" rel="noopener noreferrer" class="limesurvey-link" aria-label="'+v+'" style="text-decoration: none; display: block;">',g+='<div style="padding: 12px 16px; border-radius: 8px; background: '+p+"; border-left: 4px solid "+c+"; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;\" onmouseover=\"this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';\" onmouseout=\"this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)';\">",g+='<div style="display: flex; align-items: center; justify-content: space-between;">',g+='<div style="flex: 1;">',g+='<div style="font-weight: 600; color: '+u+'; margin-bottom: 4px;"><span aria-hidden="true" style="margin-right: 8px;">â†’</span>'+e.title+d+"</div>",r&&(g+='<div style="font-size: 0.85em; color: '+y+';">'+r+"</div>"),(e.startdate||e.expires)&&(g+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(g+='<span style="color: '+f+';"><strong>'+i.startdate+":</strong> "+s(e.startdate)+"</span>"),e.expires&&(g+='<span style="color: #d84315;"><strong>'+i.expiresdate+":</strong> "+s(e.expires)+"</span>"),g+="</div>"),g+="</div>";var m=e.completion_percentage||0,x=2*Math.PI*18,b=x-m/100*x,h=m<30?"#f44336":m<70?"#ff9800":"#4caf50",k=i.progress_aria.replace("{$a}",m);g+='<div style="position: relative; width: 48px; height: 48px;">',g+='<svg width="48" height="48" role="img" aria-label="'+k+'" style="transform: rotate(-90deg);">',g+='<circle cx="24" cy="24" r="18" fill="none" stroke="#e0e0e0" stroke-width="4"></circle>',g+='<circle cx="24" cy="24" r="18" fill="none" stroke="'+h+'" stroke-width="4" stroke-dasharray="'+x+'" stroke-dashoffset="'+b+'" stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;"></circle>',g+="</svg>",g+='<div aria-hidden="true" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 700; color: '+h+';">'+m+"%</div>",g+="</div>",g+="</div>",g+="</div>",g+="</a>",g+="</li>"}console.group(o+1+". "+e.title),console.log("Status:",e.completed?"âœ… Completed":"â¬œï¸ Pending"),console.log("URL:",e.url),e.attributes.length>0&&console.log("Attributes:",e.attributes),console.group("ğŸ” API Response Details"),console.log("Raw API Response:",e.raw_api_response),console.log("Decoded Data:",e.decoded_data),console.groupEnd(),e.completed&&(e.responseid&&console.log("Response ID:",e.responseid),Object.keys(e.responses).length>0?console.log("Responses:",e.responses):console.log("No response data available")),console.groupEnd()}})),console.groupEnd(),g+="</ul>",t.html(g);var u=e(".expires-today-badge");u.length>0&&setInterval((function(){u.fadeOut(600).fadeIn(600)}),1200),e(".view-responses").on("click",(function(o){o.preventDefault();var t=e(this).data("survey-id"),s=e("#"+t+"-responses"),n=r.surveys[parseInt(t.split("-")[1])],a=e(this);if(s.is(":visible"))s.slideUp(),a.html("ğŸ“Š "+i.viewresponses);else{var l='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;">'+i.responses+":</div>";for(var d in l+='<div style="display: grid; gap: 8px;">',n.responses)n.responses.hasOwnProperty(d)&&(l+='<div style="padding: 8px; background: #f1f8e9; border-radius: 4px; border-left: 3px solid #4caf50;">',l+='<div style="font-size: 0.8em; color: #558b2f; margin-bottom: 2px;">'+d+"</div>",l+='<div style="color: #2e7d32; font-weight: 500;">'+n.responses[d]+"</div>",l+="</div>");l+="</div>",s.html(l),s.slideDown(),a.html("ğŸ“Š "+i.hideresponses)}})),e(".limesurvey-link").on("click",(function(){console.log("ğŸ—‘ï¸ User clicked on survey, clearing cache..."),o.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done((function(e){console.log("âœ… Cache cleared:",e)})).fail((function(e){console.error("âŒ Error clearing cache:",e)}))}))}else t.html("<p>"+i.nosurveys+"</p>");else t.html('<div class="alert alert-warning">'+r.message+"</div>")})).fail((function(e){t.html('<div class="alert alert-danger">'+i.error_loading+"</div>"),r.exception(e),console.error("âŒ Error loading LimeSurvey data:",e)}))}(e,i,a)})).catch((function(e){console.error("âŒ Error loading strings:",e),i.html('<div class="alert alert-danger">Error loading language strings</div>')}))}}}));