/**
 * JavaScript for loading LimeSurvey surveys.
 *
 * @module     block_limesurvey/surveys
 * @copyright  2024, Sergio
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str"],(function(e,o,t,s){var r=function(e){if(!e||"null"===e||null===e)return"";try{var o=new Date(e);if(isNaN(o.getTime()))return"";return o.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){return""}},n=function(e){if(!e||"null"===e||null===e)return 999;try{var o=new Date(e),t=new Date,s=new Date(o.getFullYear(),o.getMonth(),o.getDate())-new Date(t.getFullYear(),t.getMonth(),t.getDate()),r=Math.round(s/864e5);return 0===r&&o<t?-1:r}catch(e){return 999}};return{init:function(){console.log("ğŸ¯ LimeSurvey block: Initializing..."),this.loadSurveys()},clearCache:function(){o.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done((function(e){console.log("âœ… Cache cleared:",e)})).fail((function(e){console.error("âŒ Error clearing cache:",e)}))},loadSurveys:function(){console.log("ğŸ“ Getting content div...");var i=e("#limesurvey-content");console.log("Content div found:",i.length>0);console.log("ğŸ“ Loading language strings..."),s.get_strings([{key:"nosurveys",component:"block_limesurvey"},{key:"activesurveys",component:"block_limesurvey"},{key:"viewresponses",component:"block_limesurvey"},{key:"hideresponses",component:"block_limesurvey"},{key:"responses",component:"block_limesurvey"},{key:"error_loading",component:"block_limesurvey"},{key:"surveyprogress",component:"block_limesurvey"},{key:"allcompleted",component:"block_limesurvey"},{key:"expiresin",component:"block_limesurvey"},{key:"expiresday",component:"block_limesurvey"},{key:"expirestoday",component:"block_limesurvey"},{key:"expired",component:"block_limesurvey"},{key:"startdate",component:"block_limesurvey"},{key:"expiresdate",component:"block_limesurvey"}]).then((function(s){console.log("âœ… Language strings loaded:",s);var a={nosurveys:s[0],activesurveys:s[1],viewresponses:s[2],hideresponses:s[3],responses:s[4],error_loading:s[5],surveyprogress:s[6],allcompleted:s[7],expiresin:s[8],expiresday:s[9],expirestoday:s[10],expired:s[11],startdate:s[12],expiresdate:s[13]};!function(e,s,i){console.log("ğŸš€ LimeSurvey block: Loading surveys..."),o.call([{methodname:"block_limesurvey_get_surveys",args:{}}])[0].done((function(t){if(console.log("âœ… LimeSurvey API response received:",t),t.success)if(0!==t.surveys.length){var a=t.surveys.length,l=0,d=0,p=0;t.surveys.forEach((function(e){e.completed?l++:d++,p+=e.completion_percentage||0}));var c=a>0?Math.round(p/a):0;t.surveys.sort((function(e,o){return e.completed&&!o.completed?1:!e.completed&&o.completed?-1:e.completed||o.completed?0:n(e.expires)-n(o.expires)})),console.group("ğŸ“Š LimeSurvey - Survey Responses"),console.log("Total surveys:",a),console.log("Completed:",l),console.log("Pending:",d),console.log("Completion:",c+"%");var g="";d>0?(g+='<div style="margin-bottom: 16px;">',g+='<div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 6px;">',g+='<span style="font-size: 0.85em; color: #1565c0; font-weight: 600;">'+c+"%</span>",g+="</div>",g+='<div style="background: #e0e0e0; height: 4px; border-radius: 2px; overflow: hidden;">',g+='<div style="background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%); height: 100%; width: '+c+'%; transition: width 0.5s ease;"></div>',g+="</div>",g+="</div>"):(g+='<div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; border-left: 3px solid #4caf50; text-align: center; font-weight: 600; color: #2e7d32; font-size: 0.9em;">',g+="ğŸ‰ "+i.allcompleted+"</div>"),g+='<div style="display: flex; flex-direction: column; gap: 10px;">',t.surveys.forEach((function(e,o){if(!e.completed&&(a=n(e.expires))<0)console.log("â­ï¸ Skipping expired survey:",e.title);else{var t=e.attributes.length>0?e.attributes.join(", "):"",s="survey-"+o;if(e.completed)g+='<div style="padding: 12px 16px; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">',g+='<div style="display: flex; align-items: center; justify-content: space-between;">',g+='<div style="flex: 1;">',g+='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 4px;"><span style="margin-right: 8px;">âœ“</span>'+e.title+"</div>",t&&(g+='<div style="font-size: 0.85em; color: #558b2f;">'+t+"</div>"),(e.startdate||e.expires)&&(g+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(g+='<span style="color: #558b2f;"><strong>'+i.startdate+":</strong> "+r(e.startdate)+"</span>"),e.expires&&(g+='<span style="color: #d84315;"><strong>'+i.expiresdate+":</strong> "+r(e.expires)+"</span>"),g+="</div>"),g+="</div>",g+='<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Completed</span>',g+="</div>",Object.keys(e.responses).length>0&&(g+='<button class="btn btn-sm view-responses" data-survey-id="'+s+'" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid #4caf50; color: #4caf50; border-radius: 4px; font-size: 0.85em; cursor: pointer; transition: all 0.2s;">ğŸ“Š '+i.viewresponses+"</button>",g+='<div id="'+s+'-responses" class="survey-responses" style="display: none; margin-top: 8px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #c8e6c9;"></div>'),g+="</div>";else{var a,l=function(e,o){return e<0?'<span style="background: #d32f2f; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 8px rgba(211,47,47,0.5); white-space: nowrap;">'+o.expired+"</span>":0===e?'<span class="expires-today-badge" style="background: #ff5722; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 12px rgba(255,87,34,0.8); white-space: nowrap;">'+o.expirestoday+"</span>":1===e?'<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; box-shadow: 0 0 6px rgba(255,152,0,0.4); white-space: nowrap;">'+o.expiresday+"</span>":e<=7?'<span style="background: #ffa726; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7em; font-weight: 600; margin-left: 8px; white-space: nowrap;">'+o.expiresin.replace("{$a}",e)+"</span>":""}(a=n(e.expires),i),d="linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)",p="#2196f3",c="#1565c0",f="#1976d2",u="#1565c0";100===e.completion_percentage?(d="linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)",p="#4caf50",c="#2e7d32",f="#558b2f",u="#558b2f"):a<0?(d="linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)",p="#d32f2f"):a<=1?(d="linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)",p="#ff5722"):a<=7&&(d="linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)",p="#ff9800"),g+='<a href="'+e.url+'" target="_blank" class="limesurvey-link" style="text-decoration: none;">',g+='<div style="padding: 12px 16px; border-radius: 8px; background: '+d+"; border-left: 4px solid "+p+"; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;\" onmouseover=\"this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)';\" onmouseout=\"this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)';\">",g+='<div style="display: flex; align-items: center; justify-content: space-between;">',g+='<div style="flex: 1;">',g+='<div style="font-weight: 600; color: '+c+'; margin-bottom: 4px;"><span style="margin-right: 8px;">â†’</span>'+e.title+l+"</div>",t&&(g+='<div style="font-size: 0.85em; color: '+f+';">'+t+"</div>"),(e.startdate||e.expires)&&(g+='<div style="font-size: 0.75em; margin-top: 6px; display: flex; gap: 12px; flex-wrap: wrap;">',e.startdate&&(g+='<span style="color: '+u+';"><strong>'+i.startdate+":</strong> "+r(e.startdate)+"</span>"),e.expires&&(g+='<span style="color: #d84315;"><strong>'+i.expiresdate+":</strong> "+r(e.expires)+"</span>"),g+="</div>"),g+="</div>";var v=e.completion_percentage||0,y=2*Math.PI*18,m=v<30?"#f44336":v<70?"#ff9800":"#4caf50";g+='<div style="position: relative; width: 48px; height: 48px;">',g+='<svg width="48" height="48" style="transform: rotate(-90deg);">',g+='<circle cx="24" cy="24" r="18" fill="none" stroke="#e0e0e0" stroke-width="4"></circle>',g+='<circle cx="24" cy="24" r="18" fill="none" stroke="'+m+'" stroke-width="4" stroke-dasharray="'+y+'" stroke-dashoffset="'+(y-v/100*y)+'" stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;"></circle>',g+="</svg>",g+='<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 700; color: '+m+';">'+v+"%</div>",g+="</div>",g+="</div>",g+="</div>",g+="</a>"}console.group(o+1+". "+e.title),console.log("Status:",e.completed?"âœ… Completed":"â¬œï¸ Pending"),console.log("URL:",e.url),e.attributes.length>0&&console.log("Attributes:",e.attributes),console.group("ğŸ” API Response Details"),console.log("Raw API Response:",e.raw_api_response),console.log("Decoded Data:",e.decoded_data),console.groupEnd(),e.completed&&(e.responseid&&console.log("Response ID:",e.responseid),Object.keys(e.responses).length>0?console.log("Responses:",e.responses):console.log("No response data available")),console.groupEnd()}})),console.groupEnd(),g+="</div>",s.html(g);var f=e(".expires-today-badge");f.length>0&&setInterval((function(){f.fadeOut(600).fadeIn(600)}),1200),e(".view-responses").on("click",(function(o){o.preventDefault();var s=e(this).data("survey-id"),r=e("#"+s+"-responses"),n=t.surveys[parseInt(s.split("-")[1])],a=e(this);if(r.is(":visible"))r.slideUp(),a.html("ğŸ“Š "+i.viewresponses);else{var l='<div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px;">'+i.responses+":</div>";for(var d in l+='<div style="display: grid; gap: 8px;">',n.responses)n.responses.hasOwnProperty(d)&&(l+='<div style="padding: 8px; background: #f1f8e9; border-radius: 4px; border-left: 3px solid #4caf50;">',l+='<div style="font-size: 0.8em; color: #558b2f; margin-bottom: 2px;">'+d+"</div>",l+='<div style="color: #2e7d32; font-weight: 500;">'+n.responses[d]+"</div>",l+="</div>");l+="</div>",r.html(l),r.slideDown(),a.html("ğŸ“Š "+i.hideresponses)}})),e(".limesurvey-link").on("click",(function(){console.log("ğŸ—‘ï¸ User clicked on survey, clearing cache..."),o.call([{methodname:"block_limesurvey_clear_cache",args:{}}])[0].done((function(e){console.log("âœ… Cache cleared:",e)})).fail((function(e){console.error("âŒ Error clearing cache:",e)}))}))}else s.html("<p>"+i.nosurveys+"</p>");else s.html('<div class="alert alert-warning">'+t.message+"</div>")})).fail((function(e){s.html('<div class="alert alert-danger">'+i.error_loading+"</div>"),t.exception(e),console.error("âŒ Error loading LimeSurvey data:",e)}))}(e,i,a)})).catch((function(e){console.error("âŒ Error loading strings:",e),i.html('<div class="alert alert-danger">Error loading language strings</div>')}))}}}));
//# sourceMappingURL=surveys.min.js.map